### SimHash

å±€éƒ¨æ•æ„Ÿhash:

â€‹	ç›¸ä¼¼çš„è¾“å…¥åœ¨å“ˆå¸Œç©ºé—´ä¸­æ˜ å°„ä¸ºæ¥è¿‘çš„å€¼

â€‹	ä¸ç›¸ä¼¼çš„è¾“å…¥åœ¨å“ˆå¸Œç©ºé—´ä¸­æ˜ å°„ä¸ºè¿œç¦»çš„å€¼

è¿™ç§ç‰¹æ€§ä½¿å¾—SimHashèƒ½å¤Ÿé€šè¿‡ç®€å•çš„æ±‰æ˜è·ç¦»è®¡ç®—å¿«é€Ÿåˆ¤æ–­ä¸¤ä¸ªæ–‡æœ¬çš„ç›¸ä¼¼æ€§ï¼Œè€Œæ— éœ€ç›´æ¥æ¯”è¾ƒåŸå§‹é«˜ç»´æ•°æ®.

**æ ¸å¿ƒæ€æƒ³ï¼š**

- ç›¸ä¼¼æ€§ä¿ç•™ï¼šç›¸ä¼¼çš„æ–‡æ¡£ç”Ÿæˆçš„å“ˆå¸Œå€¼åœ¨æ±‰æ˜è·ç¦»ä¸Šæ¥è¿‘ï¼Œè€Œå·®å¼‚å¤§çš„æ–‡æ¡£å“ˆå¸Œå€¼å·®å¼‚æ˜¾è‘—
- é™ç»´å¤„ç†ï¼šå°†é«˜ç»´æ–‡æœ¬ç‰¹å¾æ˜ å°„åˆ°å›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶æŒ‡çº¹ (å¦‚64bit)ï¼Œä¾¿äºå¿«é€Ÿæ¯”è¾ƒ

**åšæ³•ï¼š**

1. åˆ†è¯ + æƒé‡åˆ†é…ï¼šå°†æ–‡ç« åˆ†è¯ï¼Œé€šè¿‡è¯é¢‘/TF-IDFå€¼ç»™æ¯ä¸€ä¸ªtermèµ‹æƒ

2. å¾—åˆ°æ¯ä¸ªtermçš„äºŒè¿›åˆ¶å‘é‡ï¼šå¯¹æ¯ä¸ªtermè¿›è¡Œhashç”Ÿæˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶ä¸²

3. å‘é‡è½¬åŒ–åï¼ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æ–‡ç« çš„å‘é‡ï¼šæ ¹æ®æ¯ä¸ªtermçš„æƒé‡å’ŒäºŒè¿›åˆ¶å‘é‡åŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æ–‡ç« çš„å‘é‡

4. äºŒè¿›åˆ¶ç”ŸæˆæŒ‡çº¹ï¼ˆå°†æ–‡ç« å‘é‡è½¬å›äºŒè¿›åˆ¶å‘é‡ï¼‰ï¼šå°†æ–‡ç« å‘é‡è½¬ä¸ºäºŒè¿›åˆ¶æŒ‡çº¹

5. è®¡ç®—ç›¸ä¼¼åº¦ï¼šé€šè¿‡æ¯”è¾ƒä¸¤ç¯‡æ–‡ç« çš„äºŒè¿›åˆ¶æŒ‡çº¹çš„æ±‰æ˜è·ç¦»ï¼Œæ¥åˆ¤æ–­ä¸¤ç¯‡æ–‡ç« çš„ç›¸ä¼¼æ€§

   | æ­¥éª¤ | å†…å®¹                         |
   | ---- | ---------------------------- |
   | 1    | åˆ†è¯ + TF-IDF æƒé‡           |
   | 2    | æ¯ä¸ªè¯å“ˆå¸Œæˆå›ºå®šé•¿åº¦ bit ä¸²  |
   | 3    | bit ä¸²æŒ‰ 1/+wã€0/-w åŠ æƒæ±‚å’Œ |
   | 4    | å¤§äº 0 â†’ 1ï¼›å°äºç­‰äº 0 â†’ 0   |
   | 5    | å¾—åˆ°æœ€ç»ˆ SimHash             |

```python
import re
import hashlib
from collections import Counter

def tokenize(text):
    return list(text)   # ç®€å•æŒ‰å­—åˆ‡åˆ†

def compute_tfidf_weights(tokens):
    counter = Counter(tokens)
    total = len(tokens)
    return {word: count / total for word, count in counter.items()}

def hash_to_bits(word, bit_len=64):
    h = hashlib.md5(word.encode("utf-8")).hexdigest()
    binary = bin(int(h, 16))[2:].zfill(128)
    return binary[:bit_len]

def simhash(text, bit_len=64):
    tokens = tokenize(text)
    weights = compute_tfidf_weights(tokens)

    vector = [0] * bit_len

    for word, weight in weights.items():
        bits = hash_to_bits(word, bit_len)

        for i, bit in enumerate(bits):
            if bit == '1':
                vector[i] += weight
            else:
                vector[i] -= weight

    final_bits = ''.join('1' if v > 0 else '0' for v in vector)
    return final_bits

def hamming_distance(hash1, hash2):
    return sum(c1 != c2 for c1, c2 in zip(hash1, hash2))


# æµ‹è¯•æ–‡æœ¬
text1 = "æˆ‘çˆ±è‡ªç„¶è¯­è¨€å¤„ç†"
text2 = "æˆ‘å–œæ¬¢è‡ªç„¶è¯­è¨€åˆ†æ"
text3 = "å¤©ç©ºä¸­æœ‰ç¾ä¸½çš„ç™½äº‘"
text4 = "æˆ‘çˆ±é©¬é‘«æ‚¦"
text5 = "æˆ‘çˆ±zzh"

hash1 = simhash(text1)
hash2 = simhash(text2)
hash3 = simhash(text3)
hash4 = simhash(text4)
hash5 = simhash(text5)

print("æ–‡æœ¬1 SimHash:", hash1)
print("æ–‡æœ¬2 SimHash:", hash2)
print("æ–‡æœ¬3 SimHash:", hash3)
print("æ–‡æœ¬4 SimHash:", hash4)
print("æ–‡æœ¬5 SimHash:", hash5)

print("\n1 vs 2:", hamming_distance(hash1, hash2))
print("1 vs 3:", hamming_distance(hash1, hash3))
print("1 vs 4:", hamming_distance(hash1, hash4))
print("1 vs 5:", hamming_distance(hash1, hash5))

```

![image-20251202201429289](C:/Users/brainlab619/Desktop/review/insert_img/image-20251202201429289.png)

![image-20251202201508406](C:/Users/brainlab619/Desktop/review/insert_img/image-20251202201508406.png)

:star:**ä¸ºä»€ä¹ˆè¦å°†å“ˆå¸Œå€¼çš„1å’Œ0è½¬æ¢ä¸º +1å’Œ-1**

åœ¨SimHashä¸­ï¼Œå°†å“ˆå¸Œå€¼çš„1å’Œ0è½¬æ¢ä¸º+1å’Œ-1çš„æ ¸å¿ƒç›®çš„æ˜¯é€šè¿‡æƒé‡çš„æ­£è´Ÿå åŠ ï¼Œé‡åŒ–ä¸åŒè¯è¯­å¯¹æœ€ç»ˆæŒ‡çº¹çš„è´¡çŒ®æ–¹å‘ã€‚è¿™ä¸€æ­¥æ˜¯SimHashä¿ç•™æ–‡æœ¬ç›¸ä¼¼æ€§çš„å…³é”®

åŸå§‹å“ˆå¸Œå€¼çš„é—®é¢˜: è‹¥ç›´æ¥ä½¿ç”¨ 1 å’Œ 0, æ¯ä¸ªè¯å¯¹æŒ‡çº¹çš„è´¡çŒ®åªèƒ½æ˜¯â€œåŠ åˆ†â€ (æƒé‡Ã—1) æˆ–â€œä¸åŠ åˆ†â€ (æƒé‡Ã—0), æ— æ³•åæ˜ è¯è¯­å¯¹æŸä¸€ä½çš„åå‘ä½œç”¨ã€‚è½¬æ¢ä¸º +1 å’Œ -1 çš„æ„ä¹‰:  æ­£å‘è´¡çŒ®:å“ˆå¸Œå€¼ä¸º 1 â†’ è½¬æ¢ä¸º +1, æƒé‡Ã—+1è¡¨ç¤ºè¯¥è¯æ”¯æŒè¯¥ä½æœ€ç»ˆä¸º 1ã€‚åå‘è´¡çŒ®:å“ˆå¸Œå€¼ä¸º 0 â†’ è½¬æ¢ä¸º -1, æƒé‡Ã—-1è¡¨ç¤ºè¯¥è¯åå¯¹è¯¥ä½æœ€ç»ˆä¸º1(æ”¯æŒè¯¥ä½ä¸º 0)ã€‚

ç´¯åŠ ç»“æœçš„ç¬¦å·:æ‰€æœ‰è¯å¯¹è¯¥ä½çš„åŠ æƒç»“æœç›¸åŠ å:  

- è‹¥æ€»å’Œ â‰¥ 0,è¯´æ˜æ”¯æŒ 1 çš„æƒé‡æ›´å¼º,æœ€ç»ˆè¯¥ä½ä¸º 1;  

- è‹¥æ€»å’Œ < 0,è¯´æ˜æ”¯æŒ 0 çš„æƒé‡æ›´å¼º,æœ€ç»ˆè¯¥ä½ä¸º 0ã€‚

------

**æ€»ç»“**

![image-20251202202048290](C:/Users/brainlab619/Desktop/review/insert_img/image-20251202202048290.png)

------

**ä¾‹å­**

ä»¥æ–‡æœ¬ **â€œæˆ‘ çˆ± è‡ªç„¶ è¯­è¨€ å¤„ç†â€** ä¸ºä¾‹ï¼Œæˆ‘ä»¬å…ˆå¯¹åˆ†è¯åçš„ term èµ‹äºˆæƒé‡ï¼ˆè¿™é‡Œä¸ºäº†æ¼”ç¤ºæ‰‹åŠ¨è®¾å®šï¼‰ï¼š
 â€œæˆ‘â€(1), â€œçˆ±â€(2), â€œè‡ªç„¶â€(3), â€œè¯­è¨€â€(2), â€œå¤„ç†â€(1)ã€‚

**Step 1ï¼šä¸ºæ¯ä¸ª term ç”Ÿæˆå›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶ hashï¼ˆå‡è®¾ 8bitï¼‰**
 æˆ‘ä»¬ä¸ºäº”ä¸ªè¯è®¾å®šå¦‚ä¸‹ hashï¼š
 â€œæˆ‘â€â†’01011011
 â€œçˆ±â€â†’11001001
 â€œè‡ªç„¶â€â†’11100010
 â€œè¯­è¨€â€â†’01111100
 â€œå¤„ç†â€â†’00101011

**Step 2ï¼šæ„å»º 8 ç»´å‘é‡å¹¶æŒ‰æƒé‡ç´¯åŠ **
 SimHash çš„æ ¸å¿ƒæ€æƒ³æ˜¯â€”â€”å¯¹äºæ¯ä¸ªè¯çš„ hashï¼š

- bit ä¸º 1ï¼Œåˆ™å‘é‡è¯¥ä½ç´¯åŠ  +weight
- bit ä¸º 0ï¼Œåˆ™å‘é‡è¯¥ä½ç´¯åŠ  âˆ’weight

åˆå§‹å‘é‡ V ä¸ºå…¨ 0ï¼š

```
V = [0,0,0,0,0,0,0,0]
```

ä¾æ¬¡ç´¯åŠ æ¯ä¸ªè¯çš„è´¡çŒ®ï¼š

1ï¼‰â€œæˆ‘â€(æƒé‡1, 01011011) â†’ V = [-1, +1, -1, +1, +1, -1, +1, +1]
 2ï¼‰â€œçˆ±â€(2, 11001001) å åŠ å â†’ V = [1, 3, -3, -1, 3, -3, -1, 3]
 3ï¼‰â€œè‡ªç„¶â€(3, 11100010) â†’ V = [4, 6, 0, -4, 0, -6, 2, 0]
 4ï¼‰â€œè¯­è¨€â€(2, 01111100) â†’ V = [2, 8, 2, -2, 2, -4, 0, -2]
 5ï¼‰â€œå¤„ç†â€(1, 00101011) â†’ æœ€ç»ˆ V = [1, 7, 3, -3, 3, -5, 1, -1]

è¿™æ˜¯æ–‡æœ¬æœ€ç»ˆçš„åŠ æƒå‘é‡ã€‚

**Step 3ï¼šå‘é‡äºŒå€¼åŒ–ï¼ˆ>0 è¾“å‡º 1ï¼Œå¦åˆ™è¾“å‡º 0ï¼‰**

```
[1, 7, 3, -3, 3, -5, 1, -1]
â†’ 1 1 1 0 1 0 1 0
```

**æœ€ç»ˆ SimHashï¼ˆ8bitï¼‰ï¼š**

```
11101010
```

è¿™å°±æ˜¯è¯¥æ–‡æœ¬çš„ SimHash æŒ‡çº¹ã€‚SimHash çš„ä¼˜åŠ¿åœ¨äºï¼š
 ç›¸ä¼¼æ–‡æœ¬ä¼šäº§ç”Ÿç›¸ä¼¼çš„ bit ä¸²ï¼Œä»è€Œå¯é€šè¿‡æ±‰æ˜è·ç¦»å¿«é€Ÿåˆ¤æ–­æ–‡æœ¬ç›¸ä¼¼åº¦ã€‚

**æ±‰æ˜è·ç¦»çš„è®¡ç®—éå¸¸å¿«ï¼š**

- æœ¬è´¨æ˜¯ä¸¤ä¸ª 64bit æ•° XOR ä¸€ä¸‹
- å†æ•°ä¸€æ•°å…¶ä¸­ 1 çš„ä¸ªæ•°ï¼ˆpopcountï¼‰

è¿™ä¸€æ•´ä¸ªè¿‡ç¨‹æ˜¯ **CPU å•æ¡æŒ‡ä»¤çº§åˆ«çš„ä¼˜åŒ–**

â€‹	**64bit  =ï¼ˆ8 **Byteå­—èŠ‚**ï¼‰**



ä¼ ç»Ÿç‚¹ç§¯çš„è¯(å¯¹äºä¸€ä¸ªæ–‡æœ¬å‘é‡æ¥è¯´ï¼Œå®é™…ä¸Šä¼šæœ‰æˆåƒä¸Šä¸‡ç”šè‡³ä¸Šäº¿çš„æ–‡æœ¬å‘é‡)ï¼š

â€‹	embeddingå¦‚æœæ˜¯float32 = 4B

â€‹	ä¸€ä¸ªæ–‡æœ¬å‘é‡æ˜¯ 768ç»´ * 4B  = 3KB

```python
dot(x, y) = x1*y1 + x2*y2 + ... + xd*yd
```

å¯¹äº 768 ç»´å‘é‡ï¼š

â€‹	768 æ¬¡ä¹˜æ³•

â€‹	768 æ¬¡åŠ æ³•

â€‹	è¯»å– 768 ä¸ª float

â€‹	æ¯ä¸ª float æ˜¯ 4 å­—èŠ‚ï¼ˆfloat32ï¼‰

ä¹Ÿå°±æ˜¯ğŸ‘‡

æ¯æ¬¡ç›¸ä¼¼åº¦æ¯”è¾ƒè‡³å°‘éœ€è¦è¯»å–ï¼š
	768 Ã— 4 å­—èŠ‚ â‰ˆ 3KB
è€Œ simhash åªéœ€è¦ï¼š
	64bit = 8 å­—èŠ‚